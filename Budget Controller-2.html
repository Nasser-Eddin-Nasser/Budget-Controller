<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>‚Ç¨ Budget Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-theme="dark" aria-live="polite">
  <header class="summary" aria-label="Summary header">
    <div class="summary-inner">
      <div class="kpis" role="region" aria-label="KPIs">
        <div class="kpi" id="kpi-earnings" aria-live="polite">
          <div class="label" id="lbl-earnings">Earnings (incl. bonuses)</div>
          <div class="value" id="val-earnings">‚Ç¨0.00</div>
        </div>
        <div class="kpi" id="kpi-expenses" aria-live="polite">
          <div class="label" id="lbl-expenses">Expenses</div>
          <div class="value" id="val-expenses">‚Ç¨0.00</div>
        </div>
        <div class="kpi" id="kpi-net" aria-live="polite">
          <div class="label" id="lbl-net">Net</div>
          <div class="value" id="val-net">‚Ç¨0.00</div>
        </div>
        <div class="kpi" id="kpi-sr" aria-live="polite">
          <div class="label" id="lbl-sr">Savings Rate</div>
          <div class="value" id="val-sr">0%</div>
        </div>
      </div>
      <div class="tools">
        <button id="btn-theme" aria-pressed="false" title="Toggle dark/light">üåô/‚òÄÔ∏è</button>
        <button id="btn-sample" title="Load sample data">Sample Data</button>
        <button id="btn-reset" class="danger" title="Clear all data">Reset</button>
        <div class="spacer"></div>
        <button id="btn-export-json">Export JSON</button>
        <button id="btn-export-csv">Export CSV</button>
        <label for="file-import" class="chip" style="cursor:pointer" title="Import JSON">
          <span>Import JSON</span>
          <input id="file-import" class="sr-only" type="file" accept="application/json" />
        </label>
      </div>
    </div>
  </header>

  <main id="app" role="main">
    <!-- Earnings (monthly) -->
    <section class="card" aria-labelledby="sec-earnings">
      <div class="head">
        <div class="title" id="sec-earnings">Monthly Earnings</div>
        <span class="chip" id="earnings-chips">
          <span id="chip-earn-base">Base: ‚Ç¨0.00</span> |
          <span id="chip-earn-bonus">+ Bonuses /mo: ‚Ç¨0.00</span> |
          <b id="chip-earn-total">Total: ‚Ç¨0.00</b>
        </span>
      </div>
      <div class="body">
        <div id="earnings-rows" class="rows" aria-live="polite"></div>
        <div class="btn-row" style="margin-top:.7rem">
          <button id="add-earning">+ Add earning</button>
        </div>
      </div>
    </section>

    <!-- Bonuses (yearly -> monthly) -->
    <section class="card" aria-labelledby="sec-bonuses">
      <div class="head">
        <div class="title" id="sec-bonuses">Yearly Bonuses (auto /12)</div>
        <span class="chip" id="bonuses-subtotal">‚Ç¨0.00 / month</span>
      </div>
      <div class="body">
        <div id="bonus-rows" class="rows" aria-live="polite"></div>
        <div class="btn-row" style="margin-top:.7rem">
          <button id="add-bonus">+ Add yearly bonus</button>
        </div>
      </div>
    </section>

    <!-- Expenses -->
    <section class="card" aria-labelledby="sec-expenses">
      <div class="head">
        <div class="title" id="sec-expenses">Monthly Expenses</div>
        <span class="chip" id="expenses-subtotal">‚Ç¨0.00</span>
      </div>
      <div class="body" id="expenses-body">
        <!-- Categories injected here -->
        <div class="btn-row" style="margin-top:.6rem">
          <button id="add-category-bottom">+ Add category</button>
        </div>
      </div>
    </section>

    <!-- Yearly costs -->
    <section class="card" aria-labelledby="sec-yearly">
      <div class="head">
        <div class="title" id="sec-yearly">Yearly Costs (auto /12)</div>
        <span class="chip" id="yearly-subtotal">‚Ç¨0.00 / month</span>
      </div>
      <div class="body">
        <div id="yearly-rows" class="rows" aria-live="polite"></div>
        <div class="btn-row" style="margin-top:.7rem">
          <button id="add-yearly">+ Add yearly cost</button>
        </div>
      </div>
    </section>

    <!-- Projection & visuals -->
    <section class="card" aria-labelledby="sec-projection">
      <div class="head">
        <div class="title" id="sec-projection">Yearly Projection</div>
      </div>
      <div class="body two-col">
        <div>
          <table aria-describedby="sec-projection">
            <thead><tr><th>Metric</th><th>Amount (12√ó)</th></tr></thead>
            <tbody id="projection-rows"></tbody>
          </table>
          <div class="btn-row" style="margin-top:.6rem">
            <span class="chip" id="fixed-flex-chip">Fixed: ‚Ç¨0.00 | Flexible: ‚Ç¨0.00</span>
          </div>
        </div>

        <!-- One chart per line, full width -->
        <div class="vis-wrap">
          <div>
            <h4 style="margin:.2rem 0 .5rem">Monthly Spend by Category (bar)</h4>
            <canvas id="barCanvas" width="1200" height="420" aria-label="Bar chart of category spend" role="img"></canvas>
          </div>
          <div>
            <h4 style="margin:.2rem 0 .5rem">Category Share (donut)</h4>
            <canvas id="pieCanvas" width="1200" height="420" aria-label="Donut chart of category share" role="img"></canvas>
          </div>
          <div>
            <h4 style="margin:.2rem 0 .5rem">Fixed vs Flexible (donut)</h4>
            <canvas id="fixedCanvas" width="1200" height="420" aria-label="Donut chart fixed vs flexible" role="img"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="sec-breakdown">
      <div class="head">
        <div class="title" id="sec-breakdown">Breakdown by Category (monthly)</div>
        <span class="chip small" id="breakdown-note">Sorted by largest spend</span>
      </div>
      <div class="body">
        <table aria-describedby="sec-breakdown">
          <thead><tr><th>Category</th><th>Subtotal (‚Ç¨/mo)</th></tr></thead>
          <tbody id="breakdown-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="footer-bar" aria-label="Quick actions">
    <button class="ghost" id="btn-collapse-all" title="Collapse all categories">Collapse all</button>
    <button class="ghost" id="btn-expand-all" title="Expand all categories">Expand all</button>
  </div>

  <script>
  // =======================
  // Strings / i18n
  // =======================
  const STR = {
    earnings: "Earnings",
    expenses: "Expenses",
    net: "Net",
    savingsRate: "Savings Rate",
    monthlyEarnings: "Monthly Earnings",
    yearlyBonuses: "Yearly Bonuses (auto /12)",
    monthlyExpenses: "Monthly Expenses",
    yearlyCosts: "Yearly Costs (auto /12)",
    yearlyProjection: "Yearly Projection",
    breakdown: "Breakdown by Category (monthly)",
    addLine: "+ Add line",
    addEarning: "+ Add earning",
    addYearly: "+ Add yearly cost",
    addBonus: "+ Add yearly bonus",
    addCategory: "+ Add category",
    delete: "Delete",
    subtotal: "Subtotal",
    name: "Name",
    amount: "Amount (‚Ç¨)",
    currency: "‚Ç¨",
    sampleConfirm: "Replace your current data with sample data?",
    resetConfirm: "Clear all data and start empty?",
    importReplace: "Replace current data?",
    importMerge: "Merge with current data?",
    invalidNumber: "Value must be a number ‚â• 0",
    newCategoryPrompt: "New category name:",
    insertIndexPrompt: "Insert at position (0 = top):",
    renamePrompt: "Rename category:",
    exportFileNameJson: "budget-data.json",
    exportFileNameCsv: "budget-data.csv",
    emptyRowPlaceholder: "‚Äî",
    savings: "Savings",
    fixed: "Fixed"
  };

  // =======================
  // Utilities
  // =======================
  const KEY = "budget-controller-state-v3"; // bumped for fixed/flexible flag
  const THEME_KEY = "budget-controller-theme";

  const nfEUR = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const nfPlain = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function formatEuro(num){ const n = Number.isFinite(num) ? num : 0; return nfEUR.format(n); }
  function parseEuro(raw){
    if (raw === null || raw === undefined) return { ok:false, value:0 };
    let s = String(raw).trim();
    if (!s) return { ok:false, value:0 };
    s = s.replace(/[‚Ç¨\s]/g,'');
    if (/,/.test(s) && /\./.test(s)){
      const lastComma = s.lastIndexOf(',');
      const lastDot = s.lastIndexOf('.');
      if (lastComma > lastDot){ s = s.replace(/\./g,'').replace(',', '.'); }
      else { s = s.replace(/,/g,''); }
    } else if (/,/.test(s)){ s = s.replace(/\./g,'').replace(',', '.'); }
    const val = Number(s);
    return { ok: Number.isFinite(val) && val >= 0, value: val >= 0 ? val : 0 };
  }
  function download(filename, text, type="text/plain"){
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // =======================
  // Data Model
  // =======================
  const sampleData = {
    earnings:[{"name":"Salary","amount":3000}],
    yearlyBonuses:[{"name":"Annual Bonus","amount":2000}],
    monthlyExpenses:{
      "Apartment Kosten":[
        {"name":"Hausgeld Kosten","amount":250, "fixed":true},
        {"name":"Kredit","amount":900, "fixed":true},
        {"name":"Electricity","amount":80, "fixed":true},
        {"name":"Food & Groceries","amount":400, "fixed":false},
        {"name":"Internet","amount":35, "fixed":true}
      ],
      "Transport":[
        {"name":"KFZ","amount":50, "fixed":true},
        {"name":"Car Petrol","amount":160, "fixed":false},
        {"name":"Deutschlandticket","amount":49, "fixed":true}
      ],
      "Special Kosts":[
        {"name":"Travel","amount":100, "fixed":false},
        {"name":"Entertainment","amount":40, "fixed":false}
      ],
      "Miscellaneous":[
        {"name":"Netflix","amount":13.99, "fixed":true},
        {"name":"Disney+","amount":8.99, "fixed":true},
        {"name":"Spotify","amount":10.99, "fixed":true},
        {"name":"Clothes","amount":60, "fixed":false}
      ],
      "Investments":[
        {"name":"Crypto","amount":100, "fixed":false},
        {"name":"Aktien","amount":150, "fixed":false}
      ],
      "Savings":[{"name":"Monthly Savings Transfer","amount":300, "fixed":true}]
    },
    yearlyCosts:[
      {"name":"Versicherungen","amount":600},
      {"name":"Taxes (flat)","amount":300},
      {"name":"Taxes (car)","amount":150}
    ],
    categoriesOrder:["Apartment Kosten","Transport","Special Kosts","Miscellaneous","Investments","Savings"]
  };

  let state = loadState() || initEmpty();

  function initEmpty(){
    return {
      earnings:[],
      yearlyBonuses:[],
      monthlyExpenses:{},
      yearlyCosts:[],
      categoriesOrder:[]
    };
  }
  function loadState(){
    try{
      const s = localStorage.getItem(KEY);
      if (!s) {
        // migrate v2 -> v3 if available
        const old = localStorage.getItem('budget-controller-state-v2');
        if (!old) return null;
        const parsedOld = JSON.parse(old);
        Object.keys(parsedOld.monthlyExpenses||{}).forEach(cat=>{
          parsedOld.monthlyExpenses[cat] = (parsedOld.monthlyExpenses[cat]||[]).map(r=> ({...r, fixed: !!r.fixed}));
        });
        localStorage.setItem(KEY, JSON.stringify(parsedOld));
        return parsedOld;
      }
      const parsed = JSON.parse(s);
      if (!Array.isArray(parsed.categoriesOrder)){
        parsed.categoriesOrder = Object.keys(parsed.monthlyExpenses || {});
      }
      parsed.yearlyBonuses = parsed.yearlyBonuses || [];
      Object.keys(parsed.monthlyExpenses||{}).forEach(cat=>{
        parsed.monthlyExpenses[cat] = (parsed.monthlyExpenses[cat]||[]).map(r=> ({...r, fixed: !!r.fixed}));
      });
      return parsed;
    }catch(e){ console.warn(e); return null }
  }
  function persist(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // =======================
  // Calculations
  // =======================
  const sum = arr => arr.reduce((a,b)=> a + (Number.isFinite(b)?b:0), 0);
  const sumEarningsBase = () => sum((state.earnings||[]).map(x=> x.amount || 0));
  const sumBonusesMonthly = () => sum((state.yearlyBonuses||[]).map(x=> (x.amount||0)/12));
  const sumEarningsTotalMonthly = () => sumEarningsBase() + sumBonusesMonthly();

  function sumCategory(catName){
    const rows = state.monthlyExpenses[catName] || [];
    return sum(rows.map(r=> r.amount || 0));
  }
  function sumMonthly(){
    const monthly = sum(state.categoriesOrder.map(sumCategory));
    return monthly + sumYearlyMonthlyPortion();
  }
  function sumYearlyMonthlyPortion(){
    return sum((state.yearlyCosts||[]).map(x=> (x.amount||0) / 12));
  }
  function sumFixedMonthlyPortion(){
    const fixedMonthly = sum(state.categoriesOrder.map(cat =>
      sum((state.monthlyExpenses[cat]||[]).filter(r=> r.fixed).map(r=> r.amount||0))
    ));
    return fixedMonthly + sumYearlyMonthlyPortion(); // yearly costs treated as fixed
  }

  // =======================
  // Rendering helpers
  // =======================
  const el = sel => document.querySelector(sel);

  function renderAll(){
    renderEarnings();
    renderBonuses();
    renderExpenses();
    renderYearly();
    recomputeAll();
  }

  function renderEarnings(){
    const wrap = el('#earnings-rows');
    wrap.innerHTML = '';
    (state.earnings||[]).forEach((row, idx)=>{
      wrap.appendChild(makeRow({
        id: `earn-${idx}`,
        name: row.name,
        amount: row.amount,
        onName: val => { state.earnings[idx].name = val; recomputeAll() },
        onAmount: val => { state.earnings[idx].amount = val; recomputeAll() },
        onDelete: ()=> { state.earnings.splice(idx,1); renderEarnings(); recomputeAll() }
      }));
    });
  }

  function renderBonuses(){
    const wrap = el('#bonus-rows');
    wrap.innerHTML = '';
    (state.yearlyBonuses||[]).forEach((row, idx)=>{
      wrap.appendChild(makeRow({
        id: `bonus-${idx}`,
        name: row.name,
        amount: row.amount,
        onName: val => { state.yearlyBonuses[idx].name = val; recomputeAll() },
        onAmount: val => { state.yearlyBonuses[idx].amount = val; recomputeAll() },
        onDelete: ()=> { state.yearlyBonuses.splice(idx,1); renderBonuses(); recomputeAll() },
        hintRight: `‚Üí ${formatEuro((row.amount||0)/12)} / mo`
      }));
    });
  }

  function renderExpenses(){
    const body = el('#expenses-body');
    body.querySelectorAll('details.cat').forEach(n=> n.remove());

    state.categoriesOrder.forEach((catName, i)=>{
      const details = document.createElement('details');
      details.className = 'cat';
      details.open = true;
      details.dataset.cat = catName;

      const summary = document.createElement('summary');
      const title = document.createElement('div');
      title.className = 'cat-title';
      title.innerHTML = `<h4>${catName}</h4><span class="chip">${STR.subtotal}: <b id="sub-${cssId(catName)}">${formatEuro(sumCategory(catName))}</b></span>`;
      const actions = document.createElement('div');
      actions.className = 'cat-actions';
      actions.append(
        makeSmallBtn('Rename', ()=> renameCategory(catName)),
        makeSmallBtn('Add line', ()=> addExpenseLine(catName)),
        makeSmallBtn('Add category above', ()=> addCategoryPrompt(i)),
        makeSmallBtn('Add category below', ()=> addCategoryPrompt(i+1)),
        makeSmallBtn('Move ‚Üë', ()=> moveCategory(i, -1)),
        makeSmallBtn('Move ‚Üì', ()=> moveCategory(i, +1)),
        makeSmallBtn('Delete category', ()=> deleteCategory(catName), true)
      );
      summary.append(title, actions);
      const content = document.createElement('div');
      content.className = 'content';
      const rowsWrap = document.createElement('div');
      rowsWrap.className = 'rows';
      (state.monthlyExpenses[catName] || []).forEach((row, idx)=>{
        rowsWrap.appendChild(makeRow({
          id: `exp-${cssId(catName)}-${idx}`,
          name: row.name,
          amount: row.amount,
          onName: val => { state.monthlyExpenses[catName][idx].name = val; recomputeAll() },
          onAmount: val => { state.monthlyExpenses[catName][idx].amount = val; recomputeAll() },
          onDelete: ()=> { state.monthlyExpenses[catName].splice(idx,1); renderExpenses(); recomputeAll() },
          showFixed: true,
          fixed: !!row.fixed,
          onFixed: val => { state.monthlyExpenses[catName][idx].fixed = !!val; recomputeAll(); }
        }));
      });
      const addBtnRow = document.createElement('div');
      addBtnRow.className = 'btn-row';
      const btn = document.createElement('button');
      btn.textContent = STR.addLine;
      btn.addEventListener('click', ()=> addExpenseLine(catName));
      addBtnRow.appendChild(btn);

      content.append(rowsWrap, addBtnRow);
      details.append(summary, content);
      body.insertBefore(details, el('#add-category-bottom').parentElement);
    });
  }

  function renderYearly(){
    const wrap = el('#yearly-rows');
    wrap.innerHTML = '';
    (state.yearlyCosts||[]).forEach((row, idx)=>{
      wrap.appendChild(makeRow({
        id: `yearly-${idx}`,
        name: row.name,
        amount: row.amount,
        onName: val => { state.yearlyCosts[idx].name = val; recomputeAll() },
        onAmount: val => { state.yearlyCosts[idx].amount = val; recomputeAll() },
        onDelete: ()=> { state.yearlyCosts.splice(idx,1); renderYearly(); recomputeAll() },
        hintRight: `‚Üí ${formatEuro((row.amount||0)/12)} / mo`
      }));
    });
  }

  function makeSmallBtn(text, onClick, danger=false){
    const b = document.createElement('button');
    b.className = 'linklike' + (danger?' danger':'');
    b.type = 'button';
    b.textContent = text;
    b.addEventListener('click', onClick);
    return b;
  }
  function cssId(s){ return s.replace(/\s+/g,'-').replace(/[^\w-]/g,'').toLowerCase() }

  function makeRow({id, name='', amount=0, onName, onAmount, onDelete, hintRight, showFixed=false, fixed=false, onFixed}){
    const row = document.createElement('div');
    row.className = 'row';
    row.setAttribute('role','group');
    row.innerHTML = `
      <div>
        <label class="sr-only" for="${id}-name">${STR.name}</label>
        <input id="${id}-name" type="text" placeholder="${STR.name}" value="${name}"/>
      </div>
      <div>
        <label class="sr-only" for="${id}-amount">${STR.amount}</label>
        <input id="${id}-amount" inputmode="decimal" autocomplete="off" type="text" placeholder="${STR.amount}" value="${amount!==undefined&&amount!==null&&amount!==''? nfPlain.format(amount): ''}" />
      </div>
      <div class="row-actions">
        ${showFixed ? `<label class="checkbox chip small" title="Mark as fixed cost"><input id="${id}-fixed" type="checkbox" ${fixed? 'checked':''}/> ${STR.fixed}</label>`:''}
        ${hintRight ? `<span class="chip small" aria-hidden="true">${hintRight}</span>`:''}
        <button type="button" aria-label="Delete row" title="Delete" class="danger">‚úï</button>
      </div>
    `;
    const nameEl = row.querySelector(`#${CSS.escape(id)}-name`);
    const amtEl = row.querySelector(`#${CSS.escape(id)}-amount`);
    const delBtn = row.querySelector('button.danger');

    nameEl.addEventListener('input', (e)=> onName && onName(String(e.target.value)));
    amtEl.addEventListener('input', (e)=>{
      const {ok, value} = parseEuro(e.target.value);
      if (!ok && e.target.value.trim()!==''){
        amtEl.classList.add('invalid');
      } else {
        amtEl.classList.remove('invalid');
        if (ok) onAmount && onAmount(value);
      }
      recomputeAll();
    });
    amtEl.addEventListener('blur', (e)=>{
      const {ok, value} = parseEuro(e.target.value);
      if (ok){
        e.target.value = nfPlain.format(value);
        onAmount && onAmount(value);
        amtEl.classList.remove('invalid');
      } else if (e.target.value.trim()===''){
        onAmount && onAmount(0);
        amtEl.classList.remove('invalid');
      } else {
        amtEl.classList.add('invalid');
      }
      recomputeAll();
    });
    if (showFixed){
      const fixedEl = row.querySelector(`#${CSS.escape(id)}-fixed`);
      fixedEl.addEventListener('change', (e)=> onFixed && onFixed(!!e.target.checked));
    }
    delBtn.addEventListener('click', ()=> onDelete && onDelete());

    return row;
  }

  function addExpenseLine(cat){
    state.monthlyExpenses[cat] = state.monthlyExpenses[cat] || [];
    state.monthlyExpenses[cat].push({name:'', amount:0, fixed:false});
    renderExpenses(); recomputeAll();
    focusLastIn(cat);
  }
  function focusLastIn(cat){
    const details = document.querySelector(`details.cat[data-cat="${cat}"]`);
    if (!details) return;
    details.open = true;
    const inputs = details.querySelectorAll('input[type="text"]');
    if (inputs.length) inputs[inputs.length-1].focus();
  }

  function addCategoryPrompt(insertIndex){
    const name = prompt(STR.newCategoryPrompt);
    if (!name) return;
    let idx = insertIndex;
    if (idx === undefined || idx===null){
      const as = prompt(STR.insertIndexPrompt, String(state.categoriesOrder.length));
      idx = Math.max(0, Math.min(state.categoriesOrder.length, parseInt(as,10) || state.categoriesOrder.length));
    }
    if (state.monthlyExpenses[name]){
      alert('A category with that name already exists.');
      return;
    }
    state.monthlyExpenses[name] = [];
    state.categoriesOrder.splice(idx, 0, name);
    renderExpenses(); recomputeAll();
  }
  function moveCategory(i, delta){
    const j = i + delta;
    if (j<0 || j>=state.categoriesOrder.length) return;
    const arr = state.categoriesOrder;
    const [x] = arr.splice(i,1);
    arr.splice(j,0,x);
    renderExpenses(); recomputeAll();
  }
  function renameCategory(oldName){
    const next = prompt(STR.renamePrompt, oldName);
    if (!next || next === oldName) return;
    if (state.monthlyExpenses[next]){
      alert('A category with that name already exists.');
      return;
    }
    state.monthlyExpenses[next] = state.monthlyExpenses[oldName];
    delete state.monthlyExpenses[oldName];
    const idx = state.categoriesOrder.indexOf(oldName);
    if (idx>=0) state.categoriesOrder[idx] = next;
    renderExpenses(); recomputeAll();
  }
  function deleteCategory(cat){
    if (!confirm(`Delete category "${cat}"?`)) return;
    delete state.monthlyExpenses[cat];
    state.categoriesOrder = state.categoriesOrder.filter(c=> c!==cat);
    renderExpenses(); recomputeAll();
  }

  // =======================
  // Recompute + UI update
  // =======================
  function recomputeAll(){
    // Earnings
    const earnBase = sumEarningsBase();
    const earnBonusMo = sumBonusesMonthly();
    const earnTotalMo = earnBase + earnBonusMo;

    // Expenses
    const monthlyYearly = sumYearlyMonthlyPortion();
    const monthlyOnly = sum(state.categoriesOrder.map(sumCategory));
    const exp = monthlyOnly + monthlyYearly;

    // Fixed vs Flexible
    const fixedMo = sumFixedMonthlyPortion();
    const flexibleMo = Math.max(0, exp - fixedMo);

    // Net & SR
    const net = earnTotalMo - exp;
    const sr = earnTotalMo > 0 ? (net/earnTotalMo)*100 : 0;

    // Header KPI
    el('#val-earnings').textContent = formatEuro(earnTotalMo);
    el('#val-expenses').textContent = formatEuro(exp);
    const netEl = el('#val-net');
    netEl.textContent = formatEuro(net);
    netEl.parentElement.classList.toggle('good', net >= 0);
    netEl.parentElement.classList.toggle('bad', net < 0);
    const srEl = el('#val-sr');
    srEl.textContent = `${sr.toFixed(1)}%`;
    srEl.parentElement.classList.toggle('good', sr >= 20);
    srEl.parentElement.classList.toggle('bad', sr < 0);

    // Earnings chips
    el('#chip-earn-base').textContent = `Base: ${formatEuro(earnBase)}`;
    el('#chip-earn-bonus').textContent = `+ Bonuses /mo: ${formatEuro(earnBonusMo)}`;
    el('#chip-earn-total').textContent = `Total: ${formatEuro(earnTotalMo)}`;

    // Subtotals
    el('#expenses-subtotal').textContent = formatEuro(exp);
    el('#yearly-subtotal').textContent = `${formatEuro(monthlyYearly)} / month`;
    el('#bonuses-subtotal').textContent = `${formatEuro(earnBonusMo)} / month`;

    // Fixed/Flexible chip
    el('#fixed-flex-chip').textContent = `Fixed: ${formatEuro(fixedMo)} | Flexible: ${formatEuro(flexibleMo)}`;

    // Category chips
    state.categoriesOrder.forEach(cat=>{
      const chip = el(`#sub-${cssId(cat)}`);
      if (chip) chip.textContent = formatEuro(sumCategory(cat));
    });

    // Projection
    renderProjection(earnTotalMo, exp, net);

    // Breakdown & charts
    renderBreakdownAndCharts(fixedMo, flexibleMo);

    // Persist
    persist();
  }

  function renderProjection(earn, exp, net){
    const body = el('#projection-rows');
    body.innerHTML = '';
    [
      ["Total Earnings", formatEuro(earn*12)],
      ["Total Expenses", formatEuro(exp*12)],
      ["Net Savings", formatEuro(net*12)]
    ].forEach(([k,v])=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${k}</td><td><b>${v}</b></td>`;
      body.appendChild(tr);
    });
  }

  function renderBreakdownAndCharts(fixedMo, flexibleMo){
    const list = state.categoriesOrder.map(cat => ({cat, total: sumCategory(cat)}));
    list.sort((a,b)=> b.total - a.total);
    const tbody = el('#breakdown-body');
    tbody.innerHTML = '';
    list.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.cat}</td><td><b>${formatEuro(item.total)}</b></td>`;
      tbody.appendChild(tr);
    });

    drawBarChart('barCanvas', list);
    drawDonutChart('pieCanvas', list, 'Category share');
    drawDonutChart('fixedCanvas', [
      {cat:'Fixed', total: fixedMo},
      {cat:'Flexible', total: flexibleMo}
    ], 'Fixed vs Flexible');
  }

  // =======================
  // Charts (Canvas 2D) ‚Äì DPR aware, readable, with hover tooltips
  // =======================
  function clearCanvas(ctx){
    const {width, height} = ctx.canvas;
    ctx.clearRect(0,0,width,height);
    const dpr = window.devicePixelRatio || 1;
    if (dpr !== 1){
      ctx.canvas.style.width = ctx.canvas.width/dpr + 'px';
      ctx.canvas.style.height = ctx.canvas.height/dpr + 'px';
    }
  }
  function baseCtx(id){
    const canvas = document.getElementById(id);
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(900, rect.width * dpr);
    canvas.height = Math.max(420, rect.height * dpr);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.font = "13px system-ui";
    ctx.textBaseline = "middle";
    return ctx;
  }
  function autoPalette(n){
    const arr = [];
    for (let i=0;i<n;i++){
      const h = Math.round((360 / Math.max(1,n)) * i);
      arr.push(`hsl(${h} 70% 55%)`);
    }
    return arr;
  }
  function niceTicks(maxVal){
    const steps = 5;
    const raw = maxVal/steps;
    const pow10 = Math.pow(10, Math.floor(Math.log10(Math.max(1,raw))));
    const nice = Math.ceil(raw/pow10)*pow10;
    return { step: nice, steps };
  }

  // Tooltip helper (one div reused)
  let tooltipDiv;
  function showTip(text, evt){
    if(!tooltipDiv){
      tooltipDiv = document.createElement('div');
      Object.assign(tooltipDiv.style, {
        position:'fixed', pointerEvents:'none', padding:'6px 8px', borderRadius:'6px',
        background:'rgba(0,0,0,0.78)', color:'#fff', font:'13px system-ui', zIndex:9999
      });
      document.body.appendChild(tooltipDiv);
    }
    if(!text){ tooltipDiv.style.display='none'; return; }
    tooltipDiv.textContent = text;
    tooltipDiv.style.display='block';
    tooltipDiv.style.left = (evt.clientX + 12) + 'px';
    tooltipDiv.style.top  = (evt.clientY + 12) + 'px';
  }

  function drawBarChart(id, data){
    const ctx = baseCtx(id);
    clearCanvas(ctx);
    const pad = {l: 72, r: 24, t: 32, b: 84};
    const W = ctx.canvas.width / (window.devicePixelRatio||1);
    const H = ctx.canvas.height / (window.devicePixelRatio||1);
    const maxVal = Math.max(1, ...data.map(d=> d.total));
    const {step, steps} = niceTicks(maxVal);
    const axisMax = step*steps;
    const bars = data.length;
    const band = (W - pad.l - pad.r) / Math.max(1,bars);
    const barW = Math.max(22, band*0.6);
    const gap = Math.max(8, band*0.4);

    const cs = getComputedStyle(document.body);
    const colHair = cs.getPropertyValue('--hair');
    const colText = cs.getPropertyValue('--text');
    const colMuted = cs.getPropertyValue('--muted');

    // axes + grid
    ctx.strokeStyle = colHair; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad.l, pad.t); ctx.lineTo(pad.l, H-pad.b); ctx.lineTo(W-pad.r, H-pad.b); ctx.stroke();
    for (let i=0;i<=steps;i++){
      const y = H - pad.b - (H - pad.t - pad.b) * (i/steps);
      ctx.strokeStyle = colHair; ctx.globalAlpha = 0.6; ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke(); ctx.globalAlpha = 1;
      const val = formatEuro(axisMax * (i/steps));
      ctx.fillStyle = colMuted; ctx.fillText(val, 8, y);
    }
    ctx.fillStyle = colMuted; ctx.fillText("‚Ç¨/month", pad.l, 16);

    const pal = autoPalette(bars);
    const meta = [];
    data.forEach((d, idx)=>{
      const x = pad.l + idx*(barW+gap);
      const h = (H - pad.t - pad.b) * (d.total / axisMax);
      const y = H - pad.b - h;
      ctx.fillStyle = pal[idx];
      ctx.fillRect(x, y, barW, h);
      // value label
      const val = formatEuro(d.total);
      ctx.fillStyle = colText; ctx.font = "12px system-ui";
      ctx.fillText(val, x + 2, y - 10);
      // x label
      ctx.save();
      ctx.translate(x + barW/2, H - pad.b + 18);
      ctx.rotate(-Math.PI/6);
      const label = d.cat.length>18 ? d.cat.slice(0,17) + '‚Ä¶' : d.cat;
      const w = ctx.measureText(label).width;
      ctx.fillStyle = colText; ctx.fillText(label, -w/2, 0);
      ctx.restore();
      meta.push({x, y, w:barW, h, label:d.cat, value:d.total});
    });

    // Hover tooltip
    const canvas = ctx.canvas;
    canvas.onmousemove = (e)=>{
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const dpr = window.devicePixelRatio || 1;
      const hit = meta.find(b => mx*dpr>=b.x && mx*dpr<=b.x+b.w && my*dpr>=b.y && my*dpr<=b.y+b.h);
      showTip(hit ? `${hit.label}: ${formatEuro(hit.value)}` : null, e);
    };
    canvas.onmouseleave = ()=> showTip(null);
  }

  function drawDonutChart(id, data, centerTitle){
    const ctx = baseCtx(id);
    clearCanvas(ctx);
    const W = ctx.canvas.width / (window.devicePixelRatio||1);
    const H = ctx.canvas.height / (window.devicePixelRatio||1);
    const cx = W/2, cy = H/2;
    const R = Math.min(W, H) * 0.36;
    const r = R * 0.58;
    const total = Math.max(1, data.reduce((a,b)=> a+b.total, 0));
    const pal = autoPalette(data.length);

    let start = -Math.PI/2;
    const slices = [];
    data.forEach((d, i)=>{
      const slice = (d.total / total) * Math.PI*2;
      const end = start + slice;
      slices.push({start, end, label: d.cat, value: d.total, color: pal[i]});
      start = end;
    });
    slices.forEach(s=>{
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, R, s.start, s.end);
      ctx.closePath();
      ctx.fillStyle = s.color;
      ctx.fill();
    });
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = 'source-over';

    // legend
    const left = 18, top = 18;
    ctx.font = "14px system-ui";
    const colText = getComputedStyle(document.body).getPropertyValue('--text');
    data.forEach((d, i)=>{
      ctx.fillStyle = pal[i];
      ctx.fillRect(left, top + i*22, 14, 14);
      ctx.fillStyle = colText;
      const pct = total ? ((d.total/ (data.reduce((a,b)=>a+b.total,0) || 1))*100).toFixed(1) : '0.0';
      const label = `${d.cat} (${pct}%)`;
      ctx.fillText(label, left + 20, top + 7 + i*22);
    });

    // center text
    const colMuted = getComputedStyle(document.body).getPropertyValue('--muted');
    ctx.fillStyle = colMuted;
    ctx.textAlign = 'center';
    ctx.font = "600 16px system-ui";
    ctx.fillText(centerTitle || 'Total', cx, cy - 8);
    ctx.font = "700 18px system-ui";
    ctx.fillStyle = colText;
    ctx.fillText(formatEuro(data.reduce((a,b)=>a+b.total,0)), cx, cy + 12);
    ctx.textAlign = 'start';

    // Hover tooltip
    const canvas = ctx.canvas;
    canvas.onmousemove = (e)=>{
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const dx = mx - (W/2);
      const dy = my - (H/2);
      const dist = Math.hypot(dx, dy);
      if (dist < r || dist > R){ showTip(null); return; }
      let ang = Math.atan2(dy, dx); // -PI..PI
      if (ang < -Math.PI/2) ang += 2*Math.PI; // align to start at -PI/2
      const hit = slices.find(s => ang >= s.start && ang <= s.end);
      showTip(hit ? `${hit.label}: ${formatEuro(hit.value)}` : null, e);
    };
    canvas.onmouseleave = ()=> showTip(null);
  }

  // =======================
  // Events / Buttons
  // =======================
  function wire(){
    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
    el('#btn-theme').addEventListener('click', ()=>{
      const cur = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', cur);
      localStorage.setItem(THEME_KEY, cur);
      // redraw charts to apply theme colors immediately
      recomputeAll();
    });

    el('#add-earning').addEventListener('click', ()=>{
      state.earnings.push({name:'', amount:0});
      renderEarnings(); recomputeAll();
      const inputs = el('#earnings-rows').querySelectorAll('input[type="text"]');
      if (inputs.length) inputs[inputs.length-1].focus();
    });

    el('#add-bonus').addEventListener('click', ()=>{
      state.yearlyBonuses.push({name:'', amount:0});
      renderBonuses(); recomputeAll();
      const inputs = el('#bonus-rows').querySelectorAll('input[type="text"]');
      if (inputs.length) inputs[inputs.length-1].focus();
    });

    el('#add-yearly').addEventListener('click', ()=>{
      state.yearlyCosts.push({name:'', amount:0});
      renderYearly(); recomputeAll();
      const inputs = el('#yearly-rows').querySelectorAll('input[type="text"]');
      if (inputs.length) inputs[inputs.length-1].focus();
    });

    el('#add-category-bottom').addEventListener('click', ()=> addCategoryPrompt(state.categoriesOrder.length));

    el('#btn-collapse-all').addEventListener('click', ()=>{ document.querySelectorAll('details.cat').forEach(d=> d.open=false); });
    el('#btn-expand-all').addEventListener('click', ()=>{ document.querySelectorAll('details.cat').forEach(d=> d.open=true); });

    el('#btn-sample').addEventListener('click', ()=>{
      if (!confirm(STR.sampleConfirm)) return;
      state = JSON.parse(JSON.stringify(sampleData));
      renderAll();
    });
    el('#btn-reset').addEventListener('click', ()=>{
      if (!confirm(STR.resetConfirm)) return;
      state = initEmpty(); renderAll();
    });

    el('#btn-export-json').addEventListener('click', ()=>{
      download(STR.exportFileNameJson, JSON.stringify(state, null, 2), "application/json");
    });

    el('#btn-export-csv').addEventListener('click', ()=>{
      const lines = [];
      lines.push(['Type','Category','Name','Amount','MonthlyPortion','Fixed'].join(','));
      state.earnings.forEach(e=> lines.push([
        'Earning','','"' + (e.name||'').replaceAll('"','""') + '"',
        String((+e.amount||0).toFixed(2)),
        String((+e.amount||0).toFixed(2)),
        ''
      ].join(',')));
      state.yearlyBonuses.forEach(b=> lines.push([
        'YearlyBonus','','"'+(b.name||'').replaceAll('"','""')+'"',
        String((+b.amount||0).toFixed(2)),
        String(( (+b.amount||0)/12 ).toFixed(2)),
        ''
      ].join(',')));
      state.categoriesOrder.forEach(cat=>{
        (state.monthlyExpenses[cat]||[]).forEach(r=>{
          lines.push([
            'MonthlyExpense','"'+cat.replaceAll('"','""')+'"','"'+(r.name||'').replaceAll('"','""')+'"',
            String((+r.amount||0).toFixed(2)),
            String((+r.amount||0).toFixed(2)),
            r.fixed? 'true':'false'
          ].join(','));
        });
      });
      state.yearlyCosts.forEach(y=>{
        lines.push([
          'YearlyCost','','"'+(y.name||'').replaceAll('"','""')+'"',
          String((+y.amount||0).toFixed(2)),
          String(( (+y.amount||0)/12 ).toFixed(2)),
          'true' // yearly costs treated as fixed
        ].join(','));
      });
      download(STR.exportFileNameCsv, lines.join('\n'), "text/csv");
    });

    el('#file-import').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const doReplace = confirm(STR.importReplace);
        if (doReplace){
          state = normalizeImported(data);
        } else {
          if (!confirm(STR.importMerge)) return;
          mergeData(data);
        }
        renderAll();
      }catch(err){
        alert('Invalid JSON.');
      } finally {
        e.target.value = '';
      }
    });

    window.addEventListener('beforeunload', persist, {passive:true});
  }

  function normalizeImported(d){
    const base = initEmpty();
    base.earnings = Array.isArray(d.earnings) ? d.earnings.map(sanitizeRow) : [];
    base.yearlyBonuses = Array.isArray(d.yearlyBonuses) ? d.yearlyBonuses.map(sanitizeRow) : [];
    base.monthlyExpenses = typeof d.monthlyExpenses === 'object' && d.monthlyExpenses ? d.monthlyExpenses : {};
    Object.keys(base.monthlyExpenses).forEach(k=>{
      base.monthlyExpenses[k] = (base.monthlyExpenses[k]||[]).map(sanitizeRow);
    });
    base.yearlyCosts = Array.isArray(d.yearlyCosts) ? d.yearlyCosts.map(sanitizeRow) : [];
    base.categoriesOrder = Array.isArray(d.categoriesOrder) ? d.categoriesOrder.slice()
      : Object.keys(base.monthlyExpenses);
    return base;
  }
  function mergeData(d){
    const nd = normalizeImported(d);
    state.earnings = [...state.earnings, ...nd.earnings];
    state.yearlyBonuses = [...state.yearlyBonuses, ...nd.yearlyBonuses];
    Object.keys(nd.monthlyExpenses).forEach(cat=>{
      if (!state.monthlyExpenses[cat]){
        state.monthlyExpenses[cat] = nd.monthlyExpenses[cat];
        state.categoriesOrder.push(cat);
      } else {
        state.monthlyExpenses[cat] = [...state.monthlyExpenses[cat], ...nd.monthlyExpenses[cat]];
      }
    });
    state.yearlyCosts = [...state.yearlyCosts, ...nd.yearlyCosts];
    state.categoriesOrder = Array.from(new Set(state.categoriesOrder));
  }
  function sanitizeRow(r){
    return {
      name: String(r && r.name || ''),
      amount: Number.isFinite(+r.amount) && +r.amount >= 0 ? +r.amount : 0,
      fixed: !!(r && r.fixed)
    };
  }

  // =======================
  // Boot
  // =======================
  wire();
  if (!state.categoriesOrder.length && !state.earnings.length && !state.yearlyCosts.length && !state.yearlyBonuses.length){
    state = JSON.parse(JSON.stringify(sampleData));
  }
  Object.keys(state.monthlyExpenses||{}).forEach(cat=>{
    state.monthlyExpenses[cat] = (state.monthlyExpenses[cat]||[]).map(r=> ({...r, fixed: !!r.fixed}));
  });
  renderAll();
  </script>
</body>
</html>
