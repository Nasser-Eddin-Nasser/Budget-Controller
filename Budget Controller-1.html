<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>‚Ç¨ Budget Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #0b0c0f;
      --panel: #14161a;
      --panel-2:#1a1d22;
      --text:#e7eaf0;
      --muted:#a8b0bd;
      --accent:#4e9cff;
      --accent-2:#7dd3fc;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --ring: rgba(78,156,255,.45);
      --shadow: 0 8px 24px rgba(0,0,0,.35), 0 3px 8px rgba(0,0,0,.25);
      --hair:#262a33;
      --input:#0f1115;
      --chip:#222632;
    }
    [data-theme="light"]{
      --bg:#f7f8fb;
      --panel:#ffffff;
      --panel-2:#f5f7fb;
      --text:#0f172a;
      --muted:#475569;
      --accent:#2563eb;
      --accent-2:#0891b2;
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --ring: rgba(37,99,235,.35);
      --shadow: 0 10px 26px rgba(2,6,23,.08), 0 2px 8px rgba(2,6,23,.06);
      --hair:#e5e9f2;
      --input:#ffffff;
      --chip:#eef2ff;
    }
    *{ box-sizing: border-box }
    html,body{height:100%}
    body{
      margin:0; font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background:linear-gradient(120deg,var(--bg),var(--panel-2));
    }
    a{ color:var(--accent); text-decoration: none }
    button{
      border:1px solid var(--hair); background:var(--panel-2); color:var(--text);
      padding:.55rem .8rem; border-radius:.75rem; cursor:pointer; transition:.2s ease;
      box-shadow: 0 2px 0 rgba(0,0,0,.04) inset;
    }
    button:hover{ transform: translateY(-1px); box-shadow: var(--shadow)}
    button.ghost{ background:transparent }
    button.linklike{ background:transparent; border:none; padding:0 .25rem; color:var(--accent) }
    .btn-row{ display:flex; gap:.5rem; flex-wrap: wrap}
    .danger{ color:var(--bad) }
    .success{ color:var(--good) }
    .warn{ color:var(--warn) }
    input[type="text"]{
      width:100%;
      background:var(--input); color:var(--text); border:1px solid var(--hair);
      padding:.55rem .7rem; border-radius:.65rem; outline:none; transition:border .15s, box-shadow .15s, background .15s;
    }
    input[type="text"]:focus{
      border-color: var(--accent); box-shadow: 0 0 0 .18rem var(--ring);
    }
    input.invalid{ border-color: var(--bad); box-shadow: 0 0 0 .18rem rgba(239,68,68,.25) }
    label{ font-size:.85rem; color:var(--muted) }

    header.summary{
      position: sticky; top:0; z-index: 10; backdrop-filter: saturate(140%) blur(10px);
      background: color-mix(in oklab, var(--panel) 75%, transparent);
      border-bottom:1px solid var(--hair); box-shadow: 0 4px 30px rgba(0,0,0,.08);
    }
    .summary-inner{
      display:grid; grid-template-columns: 1fr auto; gap:1rem; align-items:center;
      max-width: 1200px; margin:0 auto; padding:.6rem 1rem;
    }
    .kpis{
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:.75rem;
    }
    .kpi{
      background:var(--panel-2); border:1px solid var(--hair); padding:.6rem .8rem; border-radius:.9rem;
      display:flex; flex-direction:column; gap:.15rem; min-height:64px;
    }
    .kpi .label{ font-size:.78rem; color:var(--muted)}
    .kpi .value{ font-size:1.15rem; font-weight:600 }
    .kpi.good .value{ color:var(--good) }
    .kpi.bad .value{ color:var(--bad) }

    .tools{ display:flex; gap:.5rem; align-items:center; flex-wrap: wrap }

    main{ max-width: 1200px; margin: 18px auto 90px; padding: 0 1rem; display:grid; gap:1rem }
    .card{
      grid-column: 1 / -1;
      background: var(--panel); border:1px solid var(--hair); border-radius: 1rem; box-shadow: var(--shadow);
      overflow: clip;
    }
    .card .head{
      display:flex; align-items:center; justify-content:space-between; gap:1rem;
      padding: .9rem 1rem; border-bottom:1px solid var(--hair); background:linear-gradient(180deg, color-mix(in oklab, var(--panel-2) 65%, transparent), transparent);
    }
    .card .title{ font-weight:700 }
    .card .body{ padding: .7rem 1rem }
    .chip{
      display:inline-flex; align-items:center; gap:.35rem; background:var(--chip); border:1px solid var(--hair);
      color:var(--muted); border-radius: 999px; padding:.2rem .5rem; font-size:.75rem
    }
    .row{ display:grid; grid-template-columns: 1.2fr .8fr auto; gap:.5rem; align-items:center }
    .row + .row{ margin-top:.5rem }
    .row .row-actions{ display:flex; gap:.35rem; justify-content:flex-end; }

    .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:1rem }
    @media (max-width: 900px){
      .kpis{ grid-template-columns: 1fr 1fr }
      .two-col{ grid-template-columns: 1fr }
      .row{ grid-template-columns: 1fr 1fr auto }
    }
    @media (max-width: 520px){
      .kpis{ grid-template-columns: 1fr 1fr }
      .row{ grid-template-columns: 1fr .9fr auto }
    }

    details.cat{
      border:1px dashed var(--hair); border-radius: .9rem; padding:.4rem; background: color-mix(in oklab, var(--panel) 98%, transparent);
    }
    details.cat summary{
      list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:.5rem;
      padding:.55rem .6rem; border-radius:.65rem; outline:none;
    }
    details.cat[open] summary{ background:var(--panel-2) }
    details.cat .content{ padding:.6rem .4rem .8rem }
    .cat-title{ display:flex; align-items:center; gap:.65rem }
    .cat-title h4{ margin:0 }
    .cat-actions{ display:flex; gap:.4rem; align-items:center; flex-wrap:wrap }
    .small{ font-size:.8rem }

    table{
      width:100%; border-collapse: collapse; font-variant-numeric: tabular-nums;
      background: var(--panel); border:1px solid var(--hair); border-radius: .75rem; overflow:hidden;
    }
    thead th{
      text-align:left; font-size:.85rem; color:var(--muted); background: var(--panel-2); border-bottom:1px solid var(--hair); padding:.6rem .6rem
    }
    tbody td{ padding:.55rem .6rem; border-bottom:1px dashed var(--hair) }
    tbody tr:last-child td{ border-bottom:none }

    .footer-bar{
      position: fixed; right:1rem; bottom:1rem; display:flex; gap:.5rem; flex-wrap:wrap;
    }

    .vis-wrap{ display:grid; grid-template-columns: 2.2fr 1.3fr; gap:1rem }
    @media (max-width: 920px){ .vis-wrap{ grid-template-columns: 1fr } }
    canvas{ width:100%; height: 360px; background:var(--panel-2); border:1px solid var(--hair); border-radius: .9rem }

    .sr-only{ position:absolute; width:1px; height:1px; margin:-1px; border:0; padding:0; clip:rect(0 0 0 0); overflow:hidden }
    .spacer{ height: .25rem }
  </style>
</head>
<body data-theme="dark" aria-live="polite">
  <header class="summary" aria-label="Summary header">
    <div class="summary-inner">
      <div class="kpis" role="region" aria-label="KPIs">
        <div class="kpi" id="kpi-earnings" aria-live="polite">
          <div class="label" id="lbl-earnings">Earnings (incl. bonuses)</div>
          <div class="value" id="val-earnings">‚Ç¨0.00</div>
        </div>
        <div class="kpi" id="kpi-expenses" aria-live="polite">
          <div class="label" id="lbl-expenses">Expenses</div>
          <div class="value" id="val-expenses">‚Ç¨0.00</div>
        </div>
        <div class="kpi" id="kpi-net" aria-live="polite">
          <div class="label" id="lbl-net">Net</div>
          <div class="value" id="val-net">‚Ç¨0.00</div>
        </div>
        <div class="kpi" id="kpi-sr" aria-live="polite">
          <div class="label" id="lbl-sr">Savings Rate</div>
          <div class="value" id="val-sr">0%</div>
        </div>
      </div>
      <div class="tools">
        <button id="btn-theme" aria-pressed="false" title="Toggle dark/light">üåô/‚òÄÔ∏è</button>
        <button id="btn-sample" title="Load sample data">Sample Data</button>
        <button id="btn-reset" class="danger" title="Clear all data">Reset</button>
        <div class="spacer"></div>
        <button id="btn-export-json">Export JSON</button>
        <button id="btn-export-csv">Export CSV</button>
        <label for="file-import" class="chip" style="cursor:pointer" title="Import JSON">
          <span>Import JSON</span>
          <input id="file-import" class="sr-only" type="file" accept="application/json" />
        </label>
      </div>
    </div>
  </header>

  <main id="app" role="main">
    <!-- Earnings (monthly) -->
    <section class="card" aria-labelledby="sec-earnings">
      <div class="head">
        <div class="title" id="sec-earnings">Monthly Earnings</div>
        <span class="chip" id="earnings-chips">
          <span id="chip-earn-base">Base: ‚Ç¨0.00</span> |
          <span id="chip-earn-bonus">+ Bonuses /mo: ‚Ç¨0.00</span> |
          <b id="chip-earn-total">Total: ‚Ç¨0.00</b>
        </span>
      </div>
      <div class="body">
        <div id="earnings-rows" class="rows" aria-live="polite"></div>
        <div class="btn-row" style="margin-top:.7rem">
          <button id="add-earning">+ Add earning</button>
        </div>
      </div>
    </section>

    <!-- Bonuses (yearly -> monthly) -->
    <section class="card" aria-labelledby="sec-bonuses">
      <div class="head">
        <div class="title" id="sec-bonuses">Yearly Bonuses (auto /12)</div>
        <span class="chip" id="bonuses-subtotal">‚Ç¨0.00 / month</span>
      </div>
      <div class="body">
        <div id="bonus-rows" class="rows" aria-live="polite"></div>
        <div class="btn-row" style="margin-top:.7rem">
          <button id="add-bonus">+ Add yearly bonus</button>
        </div>
      </div>
    </section>

    <!-- Expenses -->
    <section class="card" aria-labelledby="sec-expenses">
      <div class="head">
        <div class="title" id="sec-expenses">Monthly Expenses</div>
        <span class="chip" id="expenses-subtotal">‚Ç¨0.00</span>
      </div>
      <div class="body" id="expenses-body">
        <!-- Categories injected here -->
        <div class="btn-row" style="margin-top:.6rem">
          <button id="add-category-bottom">+ Add category</button>
        </div>
      </div>
    </section>

    <!-- Yearly costs -->
    <section class="card" aria-labelledby="sec-yearly">
      <div class="head">
        <div class="title" id="sec-yearly">Yearly Costs (auto /12)</div>
        <span class="chip" id="yearly-subtotal">‚Ç¨0.00 / month</span>
      </div>
      <div class="body">
        <div id="yearly-rows" class="rows" aria-live="polite"></div>
        <div class="btn-row" style="margin-top:.7rem">
          <button id="add-yearly">+ Add yearly cost</button>
        </div>
      </div>
    </section>

    <!-- Projection & visuals -->
    <section class="card" aria-labelledby="sec-projection">
      <div class="head">
        <div class="title" id="sec-projection">Yearly Projection</div>
      </div>
      <div class="body two-col">
        <div>
          <table aria-describedby="sec-projection">
            <thead><tr><th>Metric</th><th>Amount (12√ó)</th></tr></thead>
            <tbody id="projection-rows"></tbody>
          </table>
        </div>
        <div class="vis-wrap">
          <div>
            <h4 style="margin:.2rem 0 .5rem">Monthly Spend by Category (bar)</h4>
            <canvas id="barCanvas" width="900" height="420" aria-label="Bar chart of category spend" role="img"></canvas>
          </div>
          <div>
            <h4 style="margin:.2rem 0 .5rem">Category Share (donut)</h4>
            <canvas id="pieCanvas" width="900" height="420" aria-label="Donut chart of category share" role="img"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="sec-breakdown">
      <div class="head">
        <div class="title" id="sec-breakdown">Breakdown by Category (monthly)</div>
        <span class="chip small" id="breakdown-note">Sorted by largest spend</span>
      </div>
      <div class="body">
        <table aria-describedby="sec-breakdown">
          <thead><tr><th>Category</th><th>Subtotal (‚Ç¨/mo)</th></tr></thead>
          <tbody id="breakdown-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="footer-bar" aria-label="Quick actions">
    <button class="ghost" id="btn-collapse-all" title="Collapse all categories">Collapse all</button>
    <button class="ghost" id="btn-expand-all" title="Expand all categories">Expand all</button>
  </div>

  <script>
  // =======================
  // Strings / i18n
  // =======================
  const STR = {
    earnings: "Earnings",
    expenses: "Expenses",
    net: "Net",
    savingsRate: "Savings Rate",
    monthlyEarnings: "Monthly Earnings",
    yearlyBonuses: "Yearly Bonuses (auto /12)",
    monthlyExpenses: "Monthly Expenses",
    yearlyCosts: "Yearly Costs (auto /12)",
    yearlyProjection: "Yearly Projection",
    breakdown: "Breakdown by Category (monthly)",
    addLine: "+ Add line",
    addEarning: "+ Add earning",
    addYearly: "+ Add yearly cost",
    addBonus: "+ Add yearly bonus",
    addCategory: "+ Add category",
    delete: "Delete",
    subtotal: "Subtotal",
    name: "Name",
    amount: "Amount (‚Ç¨)",
    currency: "‚Ç¨",
    sampleConfirm: "Replace your current data with sample data?",
    resetConfirm: "Clear all data and start empty?",
    importReplace: "Replace current data?",
    importMerge: "Merge with current data?",
    invalidNumber: "Value must be a number ‚â• 0",
    newCategoryPrompt: "New category name:",
    insertIndexPrompt: "Insert at position (0 = top):",
    renamePrompt: "Rename category:",
    exportFileNameJson: "budget-data.json",
    exportFileNameCsv: "budget-data.csv",
    emptyRowPlaceholder: "‚Äî",
    savings: "Savings"
  };

  // =======================
  // Utilities
  // =======================
  const KEY = "budget-controller-state-v2"; // bumped for new fields
  const THEME_KEY = "budget-controller-theme";

  const nfEUR = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const nfPlain = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function formatEuro(num){ const n = Number.isFinite(num) ? num : 0; return nfEUR.format(n); }
  function parseEuro(raw){
    if (raw === null || raw === undefined) return { ok:false, value:0 };
    let s = String(raw).trim();
    if (!s) return { ok:false, value:0 };
    s = s.replace(/[‚Ç¨\s]/g,'');
    if (/,/.test(s) && /\./.test(s)){
      const lastComma = s.lastIndexOf(',');
      const lastDot = s.lastIndexOf('.');
      if (lastComma > lastDot){ s = s.replace(/\./g,'').replace(',', '.'); }
      else { s = s.replace(/,/g,''); }
    } else if (/,/.test(s)){ s = s.replace(/\./g,'').replace(',', '.'); }
    const val = Number(s);
    return { ok: Number.isFinite(val) && val >= 0, value: val >= 0 ? val : 0 };
  }
  function download(filename, text, type="text/plain"){
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // =======================
  // Data Model
  // =======================
  const sampleData = {
    earnings:[{"name":"Salary","amount":3500}],
    yearlyBonuses:[{"name":"Annual Bonus","amount":2400}],
    monthlyExpenses:{
      "Apartment Kosten":[
        {"name":"Hausgeld Kosten","amount":250},
        {"name":"Kredit","amount":900},
        {"name":"Electricity","amount":80},
        {"name":"Food & Groceries","amount":400},
        {"name":"Internet","amount":35}
      ],
      "Transport":[
        {"name":"KFZ","amount":50},
        {"name":"Car Petrol","amount":160},
        {"name":"Deutschlandticket","amount":49}
      ],
      "Special Kosts":[
        {"name":"Travel","amount":100},
        {"name":"Entertainment","amount":40}
      ],
      "Miscellaneous":[
        {"name":"Netflix","amount":13.99},
        {"name":"Disney+","amount":8.99},
        {"name":"Spotify","amount":10.99},
        {"name":"Clothes","amount":60}
      ],
      "Investments":[
        {"name":"Crypto","amount":100},
        {"name":"Aktien","amount":150}
      ],
      "Savings":[{"name":"Monthly Savings Transfer","amount":300}]
    },
    yearlyCosts:[
      {"name":"Versicherungen","amount":600},
      {"name":"Taxes (flat)","amount":300},
      {"name":"Taxes (car)","amount":150}
    ],
    categoriesOrder:["Apartment Kosten","Transport","Special Kosts","Miscellaneous","Investments","Savings"]
  };

  let state = loadState() || initEmpty();

  function initEmpty(){
    return {
      earnings:[],
      yearlyBonuses:[],
      monthlyExpenses:{},
      yearlyCosts:[],
      categoriesOrder:[]
    };
  }
  function loadState(){
    try{
      const s = localStorage.getItem(KEY);
      if (!s) return null;
      const parsed = JSON.parse(s);
      if (!Array.isArray(parsed.categoriesOrder)){
        parsed.categoriesOrder = Object.keys(parsed.monthlyExpenses || {});
      }
      parsed.yearlyBonuses = parsed.yearlyBonuses || [];
      return parsed;
    }catch(e){ console.warn(e); return null }
  }
  function persist(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // =======================
  // Calculations
  // =======================
  const sum = arr => arr.reduce((a,b)=> a + (Number.isFinite(b)?b:0), 0);
  const sumEarningsBase = () => sum((state.earnings||[]).map(x=> x.amount || 0));
  const sumBonusesMonthly = () => sum((state.yearlyBonuses||[]).map(x=> (x.amount||0)/12));
  const sumEarningsTotalMonthly = () => sumEarningsBase() + sumBonusesMonthly();

  function sumCategory(catName){
    const rows = state.monthlyExpenses[catName] || [];
    return sum(rows.map(r=> r.amount || 0));
  }
  function sumMonthly(){
    const monthly = sum(state.categoriesOrder.map(sumCategory));
    return monthly + sumYearlyMonthlyPortion();
  }
  function sumYearlyMonthlyPortion(){
    return sum((state.yearlyCosts||[]).map(x=> (x.amount||0) / 12));
  }

  // =======================
  // Rendering helpers
  // =======================
  const el = sel => document.querySelector(sel);

  function renderAll(){
    renderEarnings();
    renderBonuses();
    renderExpenses();
    renderYearly();
    recomputeAll();
  }

  function renderEarnings(){
    const wrap = el('#earnings-rows');
    wrap.innerHTML = '';
    (state.earnings||[]).forEach((row, idx)=>{
      wrap.appendChild(makeRow({
        id: `earn-${idx}`,
        name: row.name,
        amount: row.amount,
        onName: val => { state.earnings[idx].name = val; recomputeAll() },
        onAmount: val => { state.earnings[idx].amount = val; recomputeAll() },
        onDelete: ()=> { state.earnings.splice(idx,1); renderEarnings(); recomputeAll() }
      }));
    });
  }

  function renderBonuses(){
    const wrap = el('#bonus-rows');
    wrap.innerHTML = '';
    (state.yearlyBonuses||[]).forEach((row, idx)=>{
      wrap.appendChild(makeRow({
        id: `bonus-${idx}`,
        name: row.name,
        amount: row.amount,
        onName: val => { state.yearlyBonuses[idx].name = val; recomputeAll() },
        onAmount: val => { state.yearlyBonuses[idx].amount = val; recomputeAll() },
        onDelete: ()=> { state.yearlyBonuses.splice(idx,1); renderBonuses(); recomputeAll() },
        hintRight: `‚Üí ${formatEuro((row.amount||0)/12)} / mo`
      }));
    });
  }

  function renderExpenses(){
    const body = el('#expenses-body');
    body.querySelectorAll('details.cat').forEach(n=> n.remove());

    state.categoriesOrder.forEach((catName, i)=>{
      const details = document.createElement('details');
      details.className = 'cat';
      details.open = true;
      details.dataset.cat = catName;

      const summary = document.createElement('summary');
      const title = document.createElement('div');
      title.className = 'cat-title';
      title.innerHTML = `<h4>${catName}</h4><span class="chip">${STR.subtotal}: <b id="sub-${cssId(catName)}">${formatEuro(sumCategory(catName))}</b></span>`;
      const actions = document.createElement('div');
      actions.className = 'cat-actions';
      actions.append(
        makeSmallBtn('Rename', ()=> renameCategory(catName)),
        makeSmallBtn('Add line', ()=> addExpenseLine(catName)),
        makeSmallBtn('Add category above', ()=> addCategoryPrompt(i)),
        makeSmallBtn('Add category below', ()=> addCategoryPrompt(i+1)),
        makeSmallBtn('Move ‚Üë', ()=> moveCategory(i, -1)),
        makeSmallBtn('Move ‚Üì', ()=> moveCategory(i, +1)),
        makeSmallBtn('Delete category', ()=> deleteCategory(catName), true)
      );
      summary.append(title, actions);
      const content = document.createElement('div');
      content.className = 'content';
      const rowsWrap = document.createElement('div');
      rowsWrap.className = 'rows';
      (state.monthlyExpenses[catName] || []).forEach((row, idx)=>{
        rowsWrap.appendChild(makeRow({
          id: `exp-${cssId(catName)}-${idx}`,
          name: row.name,
          amount: row.amount,
          onName: val => { state.monthlyExpenses[catName][idx].name = val; recomputeAll() },
          onAmount: val => { state.monthlyExpenses[catName][idx].amount = val; recomputeAll() },
          onDelete: ()=> { state.monthlyExpenses[catName].splice(idx,1); renderExpenses(); recomputeAll() }
        }));
      });
      const addBtnRow = document.createElement('div');
      addBtnRow.className = 'btn-row';
      const btn = document.createElement('button');
      btn.textContent = STR.addLine;
      btn.addEventListener('click', ()=> addExpenseLine(catName));
      addBtnRow.appendChild(btn);

      content.append(rowsWrap, addBtnRow);
      details.append(summary, content);
      body.insertBefore(details, el('#add-category-bottom').parentElement);
    });
  }

  function renderYearly(){
    const wrap = el('#yearly-rows');
    wrap.innerHTML = '';
    (state.yearlyCosts||[]).forEach((row, idx)=>{
      wrap.appendChild(makeRow({
        id: `yearly-${idx}`,
        name: row.name,
        amount: row.amount,
        onName: val => { state.yearlyCosts[idx].name = val; recomputeAll() },
        onAmount: val => { state.yearlyCosts[idx].amount = val; recomputeAll() },
        onDelete: ()=> { state.yearlyCosts.splice(idx,1); renderYearly(); recomputeAll() },
        hintRight: `‚Üí ${formatEuro((row.amount||0)/12)} / mo`
      }));
    });
  }

  function makeSmallBtn(text, onClick, danger=false){
    const b = document.createElement('button');
    b.className = 'linklike' + (danger?' danger':'');
    b.type = 'button';
    b.textContent = text;
    b.addEventListener('click', onClick);
    return b;
  }
  function cssId(s){ return s.replace(/\s+/g,'-').replace(/[^\w-]/g,'').toLowerCase() }

  function makeRow({id, name='', amount=0, onName, onAmount, onDelete, hintRight}){
    const row = document.createElement('div');
    row.className = 'row';
    row.setAttribute('role','group');
    row.innerHTML = `
      <div>
        <label class="sr-only" for="${id}-name">${STR.name}</label>
        <input id="${id}-name" type="text" placeholder="${STR.name}" value="${name}"/>
      </div>
      <div>
        <label class="sr-only" for="${id}-amount">${STR.amount}</label>
        <input id="${id}-amount" inputmode="decimal" autocomplete="off" type="text" placeholder="${STR.amount}" value="${amount!==undefined&&amount!==null&&amount!==''? nfPlain.format(amount): ''}" />
      </div>
      <div class="row-actions">
        ${hintRight ? `<span class="chip small" aria-hidden="true">${hintRight}</span>`:''}
        <button type="button" aria-label="Delete row" title="Delete" class="danger">‚úï</button>
      </div>
    `;
    const nameEl = row.querySelector(`#${CSS.escape(id)}-name`);
    const amtEl = row.querySelector(`#${CSS.escape(id)}-amount`);
    const delBtn = row.querySelector('button.danger');

    nameEl.addEventListener('input', (e)=> onName && onName(String(e.target.value)));
    amtEl.addEventListener('input', (e)=>{
      const {ok, value} = parseEuro(e.target.value);
      if (!ok && e.target.value.trim()!==''){
        amtEl.classList.add('invalid');
      } else {
        amtEl.classList.remove('invalid');
        if (ok) onAmount && onAmount(value);
      }
      recomputeAll();
    });
    amtEl.addEventListener('blur', (e)=>{
      const {ok, value} = parseEuro(e.target.value);
      if (ok){
        e.target.value = nfPlain.format(value);
        onAmount && onAmount(value);
        amtEl.classList.remove('invalid');
      } else if (e.target.value.trim()===''){
        onAmount && onAmount(0);
        amtEl.classList.remove('invalid');
      } else {
        amtEl.classList.add('invalid');
      }
      recomputeAll();
    });
    delBtn.addEventListener('click', ()=> onDelete && onDelete());

    return row;
  }

  function addExpenseLine(cat){
    state.monthlyExpenses[cat] = state.monthlyExpenses[cat] || [];
    state.monthlyExpenses[cat].push({name:'', amount:0});
    renderExpenses(); recomputeAll();
    focusLastIn(cat);
  }
  function focusLastIn(cat){
    const details = document.querySelector(`details.cat[data-cat="${cat}"]`);
    if (!details) return;
    details.open = true;
    const inputs = details.querySelectorAll('input[type="text"]');
    if (inputs.length) inputs[inputs.length-1].focus();
  }

  function addCategoryPrompt(insertIndex){
    const name = prompt(STR.newCategoryPrompt);
    if (!name) return;
    let idx = insertIndex;
    if (idx === undefined || idx===null){
      const as = prompt(STR.insertIndexPrompt, String(state.categoriesOrder.length));
      idx = Math.max(0, Math.min(state.categoriesOrder.length, parseInt(as,10) || state.categoriesOrder.length));
    }
    if (state.monthlyExpenses[name]){
      alert('A category with that name already exists.');
      return;
    }
    state.monthlyExpenses[name] = [];
    state.categoriesOrder.splice(idx, 0, name);
    renderExpenses(); recomputeAll();
  }
  function moveCategory(i, delta){
    const j = i + delta;
    if (j<0 || j>=state.categoriesOrder.length) return;
    const arr = state.categoriesOrder;
    const [x] = arr.splice(i,1);
    arr.splice(j,0,x);
    renderExpenses(); recomputeAll();
  }
  function renameCategory(oldName){
    const next = prompt(STR.renamePrompt, oldName);
    if (!next || next === oldName) return;
    if (state.monthlyExpenses[next]){
      alert('A category with that name already exists.');
      return;
    }
    state.monthlyExpenses[next] = state.monthlyExpenses[oldName];
    delete state.monthlyExpenses[oldName];
    const idx = state.categoriesOrder.indexOf(oldName);
    if (idx>=0) state.categoriesOrder[idx] = next;
    renderExpenses(); recomputeAll();
  }
  function deleteCategory(cat){
    if (!confirm(`Delete category "${cat}"?`)) return;
    delete state.monthlyExpenses[cat];
    state.categoriesOrder = state.categoriesOrder.filter(c=> c!==cat);
    renderExpenses(); recomputeAll();
  }

  // =======================
  // Recompute + UI update
  // =======================
  function recomputeAll(){
    // Earnings
    const earnBase = sumEarningsBase();
    const earnBonusMo = sumBonusesMonthly();
    const earnTotalMo = earnBase + earnBonusMo;

    // Expenses
    const monthlyYearly = sumYearlyMonthlyPortion();
    const monthlyOnly = sum(state.categoriesOrder.map(sumCategory));
    const exp = monthlyOnly + monthlyYearly;

    // Net & SR
    const net = earnTotalMo - exp;
    const sr = earnTotalMo > 0 ? (net/earnTotalMo)*100 : 0;

    // Header KPI
    el('#val-earnings').textContent = formatEuro(earnTotalMo);
    el('#val-expenses').textContent = formatEuro(exp);
    const netEl = el('#val-net');
    netEl.textContent = formatEuro(net);
    netEl.parentElement.classList.toggle('good', net >= 0);
    netEl.parentElement.classList.toggle('bad', net < 0);
    const srEl = el('#val-sr');
    srEl.textContent = `${sr.toFixed(1)}%`;
    srEl.parentElement.classList.toggle('good', sr >= 20);
    srEl.parentElement.classList.toggle('bad', sr < 0);

    // Earnings chips
    el('#chip-earn-base').textContent = `Base: ${formatEuro(earnBase)}`;
    el('#chip-earn-bonus').textContent = `+ Bonuses /mo: ${formatEuro(earnBonusMo)}`;
    el('#chip-earn-total').textContent = `Total: ${formatEuro(earnTotalMo)}`;

    // Subtotals
    el('#expenses-subtotal').textContent = formatEuro(exp);
    el('#yearly-subtotal').textContent = `${formatEuro(monthlyYearly)} / month`;
    el('#bonuses-subtotal').textContent = `${formatEuro(earnBonusMo)} / month`;

    // Category chips
    state.categoriesOrder.forEach(cat=>{
      const chip = el(`#sub-${cssId(cat)}`);
      if (chip) chip.textContent = formatEuro(sumCategory(cat));
    });

    // Projection (12√ó)
    renderProjection(earnTotalMo, exp, net);

    // Breakdown & charts
    renderBreakdownAndCharts();

    // Persist
    persist();
  }

  function renderProjection(earn, exp, net){
    const body = el('#projection-rows');
    body.innerHTML = '';
    const rows = [
      ["Total Earnings", formatEuro(earn*12)],
      ["Total Expenses", formatEuro(exp*12)],
      ["Net Savings", formatEuro(net*12)]
    ];
    rows.forEach(([k,v])=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${k}</td><td><b>${v}</b></td>`;
      body.appendChild(tr);
    });
  }

  function renderBreakdownAndCharts(){
    const list = state.categoriesOrder.map(cat => ({cat, total: sumCategory(cat)}));
    list.sort((a,b)=> b.total - a.total);
    const tbody = el('#breakdown-body');
    tbody.innerHTML = '';
    list.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.cat}</td><td><b>${formatEuro(item.total)}</b></td>`;
      tbody.appendChild(tr);
    });

    drawBarChart('barCanvas', list);
    drawDonutChart('pieCanvas', list);
  }

  // =======================
  // Charts (Canvas 2D)
  // =======================
  function clearCanvas(ctx){
    const {width, height} = ctx.canvas;
    ctx.clearRect(0,0,width,height);
    const dpr = window.devicePixelRatio || 1;
    if (dpr !== 1){
      ctx.canvas.style.width = ctx.canvas.width/dpr + 'px';
      ctx.canvas.style.height = ctx.canvas.height/dpr + 'px';
    }
  }
  function baseCtx(id){
    const canvas = document.getElementById(id);
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(600, rect.width * dpr);
    canvas.height = Math.max(300, rect.height * dpr);
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.font = "13px system-ui";
    ctx.textBaseline = "middle";
    return ctx;
  }
  function autoPalette(n){
    const arr = [];
    for (let i=0;i<n;i++){
      const h = Math.round((360 / Math.max(1,n)) * i);
      arr.push(`hsl(${h} 70% 55%)`);
    }
    return arr;
  }
  function drawBarChart(id, data){
    const ctx = baseCtx(id);
    clearCanvas(ctx);
    const pad = {l: 60, r: 20, t: 30, b: 40};
    const W = ctx.canvas.width / (window.devicePixelRatio||1);
    const H = ctx.canvas.height / (window.devicePixelRatio||1);
    const maxVal = Math.max(1, ...data.map(d=> d.total));
    const bars = data.length;
    const barW = Math.max(18, (W - pad.l - pad.r) / Math.max(1,bars) * .6);
    const gap = ((W - pad.l - pad.r) - barW*bars) / Math.max(1,bars-1);

    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted');
    ctx.fillText("‚Ç¨ / month", pad.l, 14);

    const steps = 5;
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--hair');
    ctx.lineWidth = 1;
    for (let i=0;i<=steps;i++){
      const y = pad.t + (H - pad.t - pad.b) * (i/steps);
      ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke();
      const val = nfEUR.format(maxVal * (1 - i/steps));
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted');
      ctx.fillText(val, 6, y);
    }

    const pal = autoPalette(bars);
    data.forEach((d, idx)=>{
      const x = pad.l + idx*(barW+gap);
      const h = (H - pad.t - pad.b) * (d.total / maxVal);
      const y = H - pad.b - h;
      ctx.fillStyle = pal[idx];
      ctx.fillRect(x, y, barW, h);
      ctx.save();
      ctx.translate(x + barW/2, H - pad.b + 14);
      ctx.rotate(-Math.PI/12);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text');
      const label = d.cat.length>16 ? d.cat.slice(0,15) + '‚Ä¶' : d.cat;
      ctx.fillText(label, -ctx.measureText(label).width/2, 0);
      ctx.restore();
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text');
      const val = nfEUR.format(d.total);
      ctx.fillText(val, x + 2, y - 10);
    });
  }
  function drawDonutChart(id, data){
    const ctx = baseCtx(id);
    clearCanvas(ctx);
    const W = ctx.canvas.width / (window.devicePixelRatio||1);
    const H = ctx.canvas.height / (window.devicePixelRatio||1);
    const cx = W/2, cy = H/2;
    const R = Math.min(W, H) * 0.35;
    const r = R * 0.56;
    const total = Math.max(1, data.reduce((a,b)=> a+b.total, 0));
    const pal = autoPalette(data.length);

    let start = -Math.PI/2;
    data.forEach((d, i)=>{
      const slice = (d.total / total) * Math.PI*2;
      const end = start + slice;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, R, start, end);
      ctx.closePath();
      ctx.fillStyle = pal[i];
      ctx.fill();
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation = 'source-over';
      start = end;
    });

    const left = 20, top = 20;
    ctx.font = "14px system-ui";
    data.forEach((d, i)=>{
      ctx.fillStyle = pal[i];
      ctx.fillRect(left, top + i*22, 14, 14);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text');
      const pct = total ? ((d.total/total)*100).toFixed(1) : '0.0';
      const label = `${d.cat} (${pct}%)`;
      ctx.fillText(label, left + 20, top + 7 + i*22);
    });

    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted');
    ctx.textAlign = 'center';
    ctx.font = "600 16px system-ui";
    ctx.fillText("Total", cx, cy - 6);
    ctx.font = "700 18px system-ui";
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text');
    ctx.fillText(nfEUR.format(total), cx, cy + 14);
    ctx.textAlign = 'start';
  }

  // =======================
  // Events / Buttons
  // =======================
  function wire(){
    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
    el('#btn-theme').addEventListener('click', ()=>{
      const cur = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', cur);
      localStorage.setItem(THEME_KEY, cur);
    });

    el('#add-earning').addEventListener('click', ()=>{
      state.earnings.push({name:'', amount:0});
      renderEarnings(); recomputeAll();
      const inputs = el('#earnings-rows').querySelectorAll('input[type="text"]');
      if (inputs.length) inputs[inputs.length-1].focus();
    });

    el('#add-bonus').addEventListener('click', ()=>{
      state.yearlyBonuses.push({name:'', amount:0});
      renderBonuses(); recomputeAll();
      const inputs = el('#bonus-rows').querySelectorAll('input[type="text"]');
      if (inputs.length) inputs[inputs.length-1].focus();
    });

    el('#add-yearly').addEventListener('click', ()=>{
      state.yearlyCosts.push({name:'', amount:0});
      renderYearly(); recomputeAll();
      const inputs = el('#yearly-rows').querySelectorAll('input[type="text"]');
      if (inputs.length) inputs[inputs.length-1].focus();
    });

    el('#add-category-bottom').addEventListener('click', ()=> addCategoryPrompt(state.categoriesOrder.length));

    el('#btn-collapse-all').addEventListener('click', ()=>{ document.querySelectorAll('details.cat').forEach(d=> d.open=false); });
    el('#btn-expand-all').addEventListener('click', ()=>{ document.querySelectorAll('details.cat').forEach(d=> d.open=true); });

    el('#btn-sample').addEventListener('click', ()=>{
      if (!confirm(STR.sampleConfirm)) return;
      state = JSON.parse(JSON.stringify(sampleData));
      renderAll();
    });
    el('#btn-reset').addEventListener('click', ()=>{
      if (!confirm(STR.resetConfirm)) return;
      state = initEmpty(); renderAll();
    });

    el('#btn-export-json').addEventListener('click', ()=>{
      download(STR.exportFileNameJson, JSON.stringify(state, null, 2), "application/json");
    });

    el('#btn-export-csv').addEventListener('click', ()=>{
      const lines = [];
      lines.push(['Type','Category','Name','Amount','MonthlyPortion'].join(','));
      state.earnings.forEach(e=> lines.push([
        'Earning','','"' + (e.name||'').replaceAll('"','""') + '"',
        String((+e.amount||0).toFixed(2)),
        String((+e.amount||0).toFixed(2))
      ].join(',')));
      state.yearlyBonuses.forEach(b=> lines.push([
        'YearlyBonus','','"'+(b.name||'').replaceAll('"','""')+'"',
        String((+b.amount||0).toFixed(2)),
        String(( (+b.amount||0)/12 ).toFixed(2))
      ].join(',')));
      state.categoriesOrder.forEach(cat=>{
        (state.monthlyExpenses[cat]||[]).forEach(r=>{
          lines.push([
            'MonthlyExpense','"'+cat.replaceAll('"','""')+'"','"'+(r.name||'').replaceAll('"','""')+'"',
            String((+r.amount||0).toFixed(2)),
            String((+r.amount||0).toFixed(2))
          ].join(','));
        });
      });
      state.yearlyCosts.forEach(y=>{
        lines.push([
          'YearlyCost','','"'+(y.name||'').replaceAll('"','""')+'"',
          String((+y.amount||0).toFixed(2)),
          String(( (+y.amount||0)/12 ).toFixed(2))
        ].join(','));
      });
      download(STR.exportFileNameCsv, lines.join('\n'), "text/csv");
    });

    el('#file-import').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const doReplace = confirm(STR.importReplace);
        if (doReplace){
          state = normalizeImported(data);
        } else {
          if (!confirm(STR.importMerge)) return;
          mergeData(data);
        }
        renderAll();
      }catch(err){
        alert('Invalid JSON.');
      } finally {
        e.target.value = '';
      }
    });

    window.addEventListener('beforeunload', persist, {passive:true});
  }

  function normalizeImported(d){
    const base = initEmpty();
    base.earnings = Array.isArray(d.earnings) ? d.earnings.map(sanitizeRow) : [];
    base.yearlyBonuses = Array.isArray(d.yearlyBonuses) ? d.yearlyBonuses.map(sanitizeRow) : [];
    base.monthlyExpenses = typeof d.monthlyExpenses === 'object' && d.monthlyExpenses ? d.monthlyExpenses : {};
    Object.keys(base.monthlyExpenses).forEach(k=>{
      base.monthlyExpenses[k] = (base.monthlyExpenses[k]||[]).map(sanitizeRow);
    });
    base.yearlyCosts = Array.isArray(d.yearlyCosts) ? d.yearlyCosts.map(sanitizeRow) : [];
    base.categoriesOrder = Array.isArray(d.categoriesOrder) ? d.categoriesOrder.slice()
      : Object.keys(base.monthlyExpenses);
    return base;
  }
  function mergeData(d){
    const nd = normalizeImported(d);
    state.earnings = [...state.earnings, ...nd.earnings];
    state.yearlyBonuses = [...state.yearlyBonuses, ...nd.yearlyBonuses];
    Object.keys(nd.monthlyExpenses).forEach(cat=>{
      if (!state.monthlyExpenses[cat]){
        state.monthlyExpenses[cat] = nd.monthlyExpenses[cat];
        state.categoriesOrder.push(cat);
      } else {
        state.monthlyExpenses[cat] = [...state.monthlyExpenses[cat], ...nd.monthlyExpenses[cat]];
      }
    });
    state.yearlyCosts = [...state.yearlyCosts, ...nd.yearlyCosts];
    state.categoriesOrder = Array.from(new Set(state.categoriesOrder));
  }
  function sanitizeRow(r){
    return {
      name: String(r && r.name || ''),
      amount: Number.isFinite(+r.amount) && +r.amount >= 0 ? +r.amount : 0
    };
  }

  // =======================
  // Boot
  // =======================
  wire();
  if (!state.categoriesOrder.length && !state.earnings.length && !state.yearlyCosts.length && !state.yearlyBonuses.length){
    state = JSON.parse(JSON.stringify(sampleData));
  }
  renderAll();

  </script>
</body>
</html>
